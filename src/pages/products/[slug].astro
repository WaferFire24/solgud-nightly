---
// src/pages/products/[slug].astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import directus from "../../lib/directus";
import { readItems } from "@directus/sdk";
import Button from "../../components/ui/Button.astro";
import Section from "../../components/ui/Section.astro";
import Container from "../../components/ui/Container.astro";
import { Image } from "astro:assets";
import { getDirectusPublicUrl, getDirectusInternalUrl } from "../../lib/config";
import { sanitizeHtml } from "../../lib/sanitize";
const directusPublicUrl = getDirectusPublicUrl();
const directusInternalUrl = getDirectusInternalUrl();

export async function getStaticPaths() {
  const products = await directus.request(
    readItems("products", {
      fields: ["slug"],
    }),
  );

  return products.map((product) => ({
    params: { slug: product.slug },
  }));
}

// 1. Ambil slug dari parameter URL
const { slug } = Astro.params;

// 2. Ambil data produk berdasarkan slug
const products = await directus.request(
  readItems("products", {
    filter: { slug: { _eq: slug } },
    fields: [
      "product_name",
      "slug",
      "image",
      "category",
      "shortdesc",
      "description",
      "year",
      "manufacturer",
      "capacity",
      "catalog",
      "page_num",
    ],
    limit: 1,
  }),
);

const product = products[0];

// 3. Jika produk tidak ditemukan, arahkan ke 404 atau tampilkan pesan
if (!product) {
  return Astro.redirect("/404");
}

const highlights = [
  { label: "Category", value: product.category || "N/A" },
  { label: "Manufacturer", value: product.manufacturer || "N/A" },
  { label: "Year", value: product.year || "N/A" },
  { label: "Capacity", value: product.capacity || "N/A" },
];
---

<BaseLayout title={`${product.product_name} - Solusi Gudang`}>
  <Section class="bg-gray-50" noContainer={true}>
    <Container class="pb-0 lg:pb-0 max-sm:pt-8 print:hidden">
      <a
        href="/products"
        class="inline-flex items-center gap-2 text-sm font-bold text-gray-400 hover:text-blue-600 transition-colors uppercase tracking-widest mb-8"
      >
        <span>‚Üê BACK TO INVENTORY</span>
      </a>
    </Container>

    <Container class="pt-0 lg:pt-0 max-md:max-w-full max-md:px-0">
      <div
        class="bg-white shadow-xl rounded-3xl overflow-hidden border border-gray-100"
      >
        <div class="grid grid-cols-1 xl:grid-cols-2">
          <div
            id="gallery-wrapper"
            class="relative bg-gray-100 aspect-square xl:aspect-auto"
          >
            {
              product.image ? (
                <Image
                  src={`${directusPublicUrl}/assets/${product.image}`}
                  alt={product.product_name}
                  width={1200}
                  height={800}
                  format="webp"
                  class="w-full h-full object-cover"
                />
              ) : (
                <div class="absolute inset-0 text-gray-200 size-full bg-gray-50 flex flex-col gap-4 items-center justify-center">
                  <span class="text-gray-400 select-none font-bold italic">
                    No Image
                  </span>
                </div>
              )
            }
          </div>

          <div class="sticky top-24 self-start">
            <div class="p-8 lg:p-12 flex flex-col items-start h-full">
              <div class="mb-8 w-full">
                <h1
                  class="text-4xl lg:text-5xl font-black text-gray-900 leading-none tracking-tighter mb-8 uppercase"
                >
                  {product.product_name}
                </h1>

                <div
                  class="prose prose-slate prose-lg max-w-none text-gray-600 mb-8"
                  set:html={sanitizeHtml(product.shortdesc)}
                />
              </div>

              <hr class="w-full border-gray-100 mb-8" />

              <!-- Feature Box (Industrial Look) -->
              <div
                class="rounded-2xl ring-1 ring-gray-100 bg-gray-50/50 w-full p-6 mb-10 text-base"
              >
                <dl class="grid grid-cols-2 gap-y-6 gap-x-4">
                  {
                    highlights.map((item) => (
                      <div>
                        <dt class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-1">
                          {item.label}
                        </dt>
                        <dd class="font-bold uppercase text-gray-900">
                          {item.value}
                        </dd>
                      </div>
                    ))
                  }
                </dl>
              </div>

              <div class="flex flex-col sm:flex-row gap-4 w-full mt-auto">
                <Button
                  href="/rfq"
                  variant="primary"
                  class="flex-1 py-5 rounded-2xl tracking-widest text-md shadow-xl shadow-gray-200 bg-blue-600! hover:bg-blue-700!"
                >
                  Ajukan Penawaran
                </Button>
                <Button
                  href={product.catalog
                    ? `${directusPublicUrl}/assets/${product.catalog}#page=${product.page_num || 1}`
                    : "#"}
                  variant="outline"
                  class="flex-1 py-5 rounded-2xl border-2 border-gray-100 tracking-widest text-md hover:border-blue-600"
                  external={true}
                >
                  Lihat Katalog
                </Button>
              </div>
            </div>
          </div>
        </div>

        <div class="p-8 lg:p-12 bg-gray-50/30 border-t border-gray-100">
          <h2
            class="text-2xl font-black uppercase tracking-tighter mb-8 flex items-center gap-3"
          >
            <span class="w-8 h-1 bg-blue-600 rounded-full"></span>
            FULL DESCRIPTION
          </h2>
          <div
            class="prose prose-slate prose-lg max-w-none mt-8 text-gray-700 leading-relaxed font-medium"
          >
            <div set:html={sanitizeHtml(product.description)} />
          </div>
        </div>
      </div>
    </Container>
  </Section>
</BaseLayout>
