---
// src/pages/products/index.astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import directus from "../../lib/directus";
import { readItems } from "@directus/sdk";
import Section from "../../components/ui/Section.astro";
import Container from "../../components/ui/Container.astro";
import CardProduct from "../../components/ui/CardProduct.astro";
import SidebarFilters from "../../components/ui/SidebarFilters.astro";
import FilterBarMobile from "../../components/ui/FilterBarMobile.astro";
import { Image } from "astro:assets";
import rfqBgImg from "@assets/banner/photo-1450101499163-c8848c66ca85.jpg";

// Cek apakah ini website staging atau produksi
// const isStaging = import.meta.env.SITE_URL?.includes("staging");
// 1. Get filter parameter from URL
const categoryFilter = Astro.url.searchParams.get("category");

// 2. Fetch ALL items to populate the sidebar categories list uniquely
let allItems = [];
try {
  const response = await directus.request(
    readItems("products", {
      fields: ["category"],
    }),
  );
  allItems = Array.isArray(response) ? response : [];
} catch (error) {}

const categoriesRaw = allItems.map((p) => p.category).filter(Boolean);
const categoryCounts = categoriesRaw.reduce((acc, cat) => {
  acc[cat] = (acc[cat] || 0) + 1;
  return acc;
}, {});
const categories = Object.keys(categoryCounts)
  .sort()
  .map((cat) => ({
    name: cat,
    count: categoryCounts[cat],
  }));

// 3. Build the filter for the main product list
const filterObj = {};
if (categoryFilter && categoryFilter !== "all") {
  filterObj["_and"] = [{ category: { _eq: categoryFilter } }];
}

// 4. Fetch the actual products based on filter
let products = [];
try {
  const productResponse = await directus.request(
    readItems("products", {
      filter: filterObj,
      fields: [
        "product_name",
        "slug",
        "image",
        "category",
        "shortdesc",
        "year",
        "manufacturer",
        "capacity",
      ],
    }),
  );
  products = Array.isArray(productResponse) ? productResponse : [];
} catch (error) {}

const sideBarData = {
  categories,
  count: products.length,
};

const searchParamsArray = Array.from(Astro.url.searchParams);
---

<BaseLayout title="Industrial Inventory - Solusi Gudang">
  <!-- Hero Section with Professional Image -->
  <section
    class="relative h-[500px] md:h-[600px] flex items-center overflow-hidden"
  >
    <!-- Background Image with Overlay -->
    <div class="absolute inset-0">
      <Image
        src={rfqBgImg}
        alt="Professional logistics and supply chain management"
        class="w-full h-full object-cover"
        width={2070}
        height={1380}
        loading="eager"
      />
      <div
        class="absolute inset-0 bg-linear-to-r from-slate-900/95 via-blue-900/90 to-slate-900/85"
      >
      </div>
    </div>

    <!-- Content -->
    <div class="container mx-auto relative z-10 px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto text-center">
        <h1
          class="text-4xl md:text-6xl lg:text-7xl font-bold text-white mb-6 leading-tight animate-fadeInUp"
          style="animation-delay: 0.1s"
        >
          Produk <span
            class="text-transparent bg-clip-text bg-linear-to-r from-blue-400 via-teal-400 to-blue-400"
            >SolusiGudang</span
          >
        </h1>
        <p
          class="text-xl md:text-2xl text-slate-200 mb-8 max-w-3xl mx-auto leading-relaxed animate-fadeInUp"
          style="animation-delay: 0.2s"
        >
          Temukan produk yang sesuai dengan kebutuhan Anda. Kami menyediakan
          Solusi pergudangan modern untuk meningkatkan efisiensi dan
          produktivitas operasional bisnis Anda.
        </p>
      </div>
    </div>
  </section>

  <Section class="bg-gray-50 flex-1" noContainer={true}>
    <Container class="pt-0 max-lg:px-0 max-lg:max-w-full">
      <div class="flex flex-col lg:flex-row">
        <FilterBarMobile params={searchParamsArray} />

        <SidebarFilters data={sideBarData} />

        <main class="lg:pl-16 grow">
          <div class="lg:px-8">
            <ul class="grid grid-cols-1 gap-8 lg:gap-12">
              {
                products.length > 0 ? (
                  products.map((product) => <CardProduct product={product} />)
                ) : (
                  <li class="bg-white p-12 text-center rounded-3xl border-2 border-dashed border-gray-200">
                    <p class="text-gray-500 font-bold uppercase tracking-widest">
                      No products found for this filter
                    </p>
                  </li>
                )
              }
            </ul>
          </div>
        </main>
      </div>
    </Container>
  </Section>
</BaseLayout>
